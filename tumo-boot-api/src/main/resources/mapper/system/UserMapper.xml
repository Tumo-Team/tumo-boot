<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.tycoding.boot.modules.system.mapper.UserMapper">

    <!-- 分页查询映射结果集 -->
    <resultMap type="cn.tycoding.boot.modules.system.dto.UserDTO" id="UserMap">
        <result property="id" column="id" jdbcType="INTEGER"/>
        <result property="username" column="username" jdbcType="VARCHAR"/>
        <result property="sex" column="sex" jdbcType="VARCHAR"/>
        <result property="email" column="email" jdbcType="VARCHAR"/>
        <result property="deptId" column="dept_id" jdbcType="INTEGER"/>
        <result property="avatar" column="avatar" jdbcType="VARCHAR"/>
        <result property="phone" column="phone" jdbcType="VARCHAR"/>
        <result property="status" column="status" jdbcType="BOOLEAN"/>
        <result property="createTime" column="create_time" jdbcType="TIMESTAMP"/>
        <collection property="roles" ofType="cn.tycoding.boot.modules.system.entity.Role"
                    select="cn.tycoding.boot.modules.system.mapper.RoleMapper.findRolesByUserId" column="id">
        </collection>
    </resultMap>

    <!-- 分页、条件查询 -->
    <select id="list" resultMap="UserMap">
        SELECT `user`.id,
               `user`.username,
               `user`.sex,
               `user`.email,
               `user`.dept_id,
               `user`.avatar,
               `user`.phone,
               `user`.status,
               `user`.create_time,
               sd.name AS deptName
        FROM sys_user AS `user`
                 LEFT JOIN sys_dept AS sd on `user`.dept_id = sd.id
        WHERE `user`.id != #{ignoreId}
            <if test="user.username != null and user.username != ''">
                AND `user`.username LIKE CONCAT('%', #{user.username},  '%')
            </if>
    </select>

    <!-- 根据ID查询 -->
    <select id="findById" resultMap="UserMap">
        SELECT `user`.id,
           `user`.username,
           `user`.sex,
           `user`.email,
           `user`.dept_id,
           `user`.avatar,
           `user`.phone,
           `user`.status,
           `user`.create_time,
           sd.name AS deptName
        FROM sys_user AS `user`
                LEFT JOIN sys_dept AS sd on `user`.dept_id = sd.id
        WHERE `user`.id = #{id}
    </select>

    <select id="roleList" resultType="Long">
        SELECT `role`.id
        FROM sys_user `user`,
             sys_user_role sur,
             sys_role `role`
        WHERE `user`.id = sur.user_id
          AND sur.role_id = `role`.id
          AND `user`.id = #{id}
    </select>
</mapper>
